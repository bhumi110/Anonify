<% layout("/layouts/boilerplate.ejs")%>
    <br><br>
    <div class="back offset-2 ">
        <a href="/feed"><i class="fa-solid fa-arrow-left"></i> Back to Feed</a>
    </div>


    <div class="col-8 offset-2 mt-3 mb-2">
        <div class="card postcard">
            <div class="card-body postcard-body">
                <h4 class="card-title postcard-title">
                    <%=post.title%>
                </h4>
                <span class="badge rounded-pill text-bg-danger card-badge <%=post.category%> mb-2">
                    <%=post.category%>
                </span>
                <% if(post.anonymous){%>
                    <span class="badge rounded-pill text-bg-dark card-badge anonymous ">Anonymous</span>
                    <%}%>
                        <% if(!post.anonymous){%>
                            <span class="badge rounded-pill text-bg-dark card-badge owner ">@<%=post.owner.username%>
                            </span>
                            <%}%>
                                <div class="post-meta">
                                    <small class="text-mute">
                                        <i class="bi bi-clock"></i>
                                        <i class="fa-regular fa-clock"></i>
                                        <%= post.timeAgo %>
                                    </small>
                                </div>

                                <div>
                                    <% for(let tag of post.tags){%>
                                        <span class="badge rounded-pill text-bg-info card-badge <%=post.tags%>">
                                            <%=tag%>
                                        </span>
                                        <%}%>
                                </div>

                                <p class="card-text postcard-text mt-2">
                                    <%=post.story%>
                                </p>
            </div>
            <% if(currUser && currUser._id.equals(post.owner._id)){%>
                <div class="post-btn mt-4 ">
                    <a href="/post/<%=post._id%>/edit">
                        <button class="btn btn-outline-light post-edit">Edit</button>
                    </a>
                    <form action="/post/<%=post._id%>?_method=DELETE" method="post">
                        <button class="btn btn-outline-light post-delete">Delete</button>
                    </form>
                </div>
                <%}%>

                    <hr>
                    <div class="reactions d-flex gap-3">
                        <button class="reaction-btn" data-id="<%= post._id %>" data-reaction="fire">ðŸ”¥ <span>
                                <%= post.reactions?.fire || 0 %>
                            </span></button>
                        <button class="reaction-btn" data-id="<%= post._id %>" data-reaction="drama">ðŸŽ­ <span>
                                <%= post.reactions?.drama || 0 %>
                            </span></button>
                        <button class="reaction-btn" data-id="<%= post._id %>" data-reaction="skull">ðŸ’€ <span>
                                <%= post.reactions?.skull || 0 %>
                            </span></button>
                        <button class="reaction-btn" data-id="<%= post._id %>" data-reaction="shock">ðŸ˜³ <span>
                                <%= post.reactions?.shock || 0 %>
                            </span></button>
                    </div>

        </div>

        <% if(currUser){%>
            <div class="comment postcard mt-4">

                <form action="/post/<%=post._id%>/comments" method="post" novalidate class="needs-validation">
                    <h5>Share Your Advice</h5>
                    <div class="comment-box mb-3">
                        <textarea class="form-control " rows="5"
                            placeholder="What would you do in this situation? Share your thoughs..."
                            name="comment[comment]" type="text" id="comment" required></textarea>
                    </div>
                    <div class="comment-btn">
                        <button type="submit" class="btn btn-info nav-btn comment-btn"><i
                                class="fa-regular fa-comment"></i>
                            Add Comment</button></a>
                    </div>
                </form>
            </div>
            <%}%>


                <div class="mt-5">

                    <h4>Advice & Opinions</h4>

                    <% for (let comment of post.comments) { %>
                        <div class="comment-card mt-4">
                            <div class="post-meta comment-time">
                                <small class="text-mute">
                                    <i class="fa-regular fa-clock"></i>
                                    <%= comment.timeAgo %>
                                </small>
                            </div>

                            <span class="badge rounded-pill text-bg-dark card-badge owner ">@
                                <%=comment.author.username%>
                            </span>

                            <p class="comment-text ">
                                <%= comment.comment %>
                            </p>

                            <div class="comment-actions d-flex gap-4">
                                <div class="comment-review">

                                    <button class=" reply-btn btn btn-outline-light" data-id="<%=comment._id%>"
                                        data-review="heart"><i class="fa-solid fa-heart"></i><span>
                                            <%= comment.review ? comment.review.heart : 0 %>
                                        </span>
                                    </button>

                                    <button class=" reply-btn btn btn-outline-light" data-id="<%=comment._id%>"
                                        data-review="brokenheart"><i class="fa-solid fa-heart-crack"></i><span>
                                            <%= comment.review ? comment.review.brokenheart : 0 %>
                                        </span>
                                    </button>
                                </div>

                                <form class="reply-form needs-validation" style="display: none;" novalidate>
                                    <input input class="form-control mb-2" type="text" name="reply[reply]" placeholder="Write your reply..." required  />

                                    <button type="submit" class="btn btn-outline-light reply-btn" ><i class="fa-solid fa-paper-plane"></i> Send</button>
                                </form>

                                <button type="submit" class="btn btn-outline-light reply-btn toggle-reply-btn">
                                        Reply
                                </button>

                                <% if(currUser && currUser._id.equals(comment.author._id)){%>
                                    <form action="/post/<%=post._id%>/comments/<%=comment._id%>?_method=DELETE"
                                        method="post">
                                        <button class="btn btn-outline-light reply-btn"><i
                                                class="fa-solid fa-trash"></i>
                                            Delete
                                        </button>

                                    </form>
                                    <%}%>

                            </div>
                        </div>

                        <% } %>
                    <br><br><br>
                </div>
    </div>


    <script>
        document.querySelectorAll(".reaction-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const postId = btn.dataset.id;
                const reaction = btn.dataset.reaction;

                try {
                    const res = await fetch(`/post/${postId}/react/${reaction}`, { method: "POST" });
                    const data = await res.json();
                    if (data.success) {
                        const span = btn.querySelector("span");
                        span.textContent = parseInt(span.textContent) + 1;
                    }
                } catch (err) {
                    console.error("Reaction failed", err);
                }
            });
        });

        document.querySelectorAll(".comment-review button").forEach(btn => {
            btn.addEventListener("click", async () => {
                const postId = "<%= post._id %>";
                const commentId = btn.dataset.id;
                const review = btn.dataset.review;

                try {
                    const res = await fetch(`/post/${postId}/comment/${commentId}/review/${review}`, {
                        method: "POST"
                    });

                    const data = await res.json();
                    if (data.success) {
                        const span = btn.querySelector("span");
                        span.textContent = parseInt(span.textContent) + 1;
                    }
                } catch (err) {
                    console.error("Review failed", err);
                }
            });
        });


        document.querySelectorAll(".toggle-reply-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const form = btn.previousElementSibling; 
                form.style.display = (form.style.display === "none" || !form.style.display) ? "block" : "none";
            });
        });



    </script>